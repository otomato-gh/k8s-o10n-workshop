# Vertical Pod Autoscaler

The Vertical Pod Autoscaler consists of 3 components:

- The VPA Recommender analyzes resource usage patterns and generates recommendations for CPU and memory settings. 

- The VPA Updater is responsible for applying the recommendations generated by the Recommender. When operating in "Auto" mode, the Updater will delete pods that need updating and create new ones with the adjusted resource settings. 

- The VPA Admission Controller intercepts pod creation requests and modifies the resource requirements according to the VPA recommendations. This ensures that even newly created pods start with adjusted resource settings, improving overall cluster efficiency from the outset. 

---

## Install the VPA

.lab[
```
cd ~
git clone https://github.com/kubernetes/autoscaler.git
cd autoscaler/vertical-pod-autoscaler
./hack/vpa-up.sh
```
]

---

## Create the VPA definition for our app

```yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: busyhttp-vpa
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind:       Deployment
    name:       busyhttp
  updatePolicy:
    updateMode: "Auto"
    minReplicas: 1
```
.lab[
```
    kubectl apply -f ~/k8s-o10n-workshop/scripts/vpa-busyhttp.yaml
```
]

---

## Triggering the VPA

- Let's deploy busyhttp with no resource definitions (if it's not running yet)

.lab[
```bash
    kubectl create deployment busyhttp --image=otomato/busyhttp:memory
```
Now let's create some cpu load
```bash
    kubectl run netutils --image=otomato/net-utils "ping localhost"
    kubectl exec netutils -- httping http://busyhttp/
```

Watch pod cpu usage go up:
```bash
    kubectl top pod -lapp=busyhttp
```

]
---

## Monitor the VPA status

- Let's see what happens in the VPA

.lab[
```bash
kubectl get vpa busyhttp
```
]

- And the updater logs:

.lab[
```bash
kubectl logs -n kube-system -l app=vpa-updater -f
```
]

- Note:  `updatePolicy.minReplicas: 1` allows to evict the pod even if it's the only one in Deployment

---

## VPA - the good parts

- Easy to set up

- Only requires metrics-server to operate

- Gets rid of guesswork when  setting resources

---

## VPA - the worse parts

- Need to configure per workload

- Relies on the [decaying histogram](https://github.com/kubernetes/autoscaler/blob/vertical-pod-autoscaler-0.8.0/vertical-pod-autoscaler/pkg/recommender/util/decaying_histogram.go#L43) algorithm (not revision-aware)

- Blocks config changes (need to turn off admission controller and updater )

- Not a good fit for highly volatile workloads in Auto mode (can cause a lot of restarts)


